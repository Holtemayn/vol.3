{% set initial = initial_forecast %}
<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Caf√©Caster v3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@openai/chat-components@0.2.2/dist/style.css">
    <style>
        body { background: #f7f7f7; color: #222; }
        header { margin: 3rem 0 2rem; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 999px; background: #0F6CBD; color: #fff; font-size: 0.8rem; }
        .panel { background: #fff; border-radius: 12px; padding: 2rem; box-shadow: 0 16px 40px rgba(15,107,189,0.08); margin-bottom: 2rem; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; border-bottom: 1px solid #e5e5ea; text-align: left; }
        th { background: linear-gradient(90deg, rgba(15,107,189,0.12), rgba(15,107,189,0.02)); font-weight: 600; }
        tr:hover { background: rgba(15,107,189,0.04); }
        .diff-positive { color: #0f766e; font-weight: 600; }
        .diff-negative { color: #b91c1c; font-weight: 600; }
        .warning { background: rgba(234,179,8,0.16); border-left: 4px solid #facc15; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 0.75rem; }
        .controls .row { margin-bottom: 0.75rem; }
        .footer { margin: 4rem 0 2rem; text-align: center; color: #777; font-size: 0.9rem; }
        #chatkit-host { margin-top: 2rem; padding: 1.5rem; border: 2px dashed rgba(15,107,189,0.35); border-radius: 12px; text-align: center; background: rgba(15,107,189,0.05); }
        .log-list { list-style: none; padding-left: 0; margin-top: 1rem; }
        .log-list li { border-bottom: 1px solid #e5e5ea; padding: 0.75rem 0; }
        .log-meta { font-size: 0.85rem; color: #555; display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .log-weather { margin-top: 0.5rem; font-size: 0.85rem; color: #333; }
        details.log-entry { margin-bottom: 0.75rem; border: 1px solid #e5e5ea; border-radius: 8px; padding: 0.75rem 1rem; background: #fafafa; }
        details.log-entry summary { cursor: pointer; font-weight: 600; outline: none; }
        .log-table { width: 100%; border-collapse: collapse; margin-top: 0.75rem; }
        .log-table th, .log-table td { font-size: 0.85rem; text-align: left; padding: 0.35rem 0.5rem; border-bottom: 1px solid #e5e5ea; }
        .log-table th { font-weight: 600; color: #444; background: rgba(15,107,189,0.08); }
        .log-table tr:last-child td { border-bottom: none; }
        .chat-window { border: 1px solid #e5e5ea; border-radius: 8px; padding: 1rem; max-height: 320px; overflow-y: auto; background: #fafafa; }
        .chat-message { margin-bottom: 0.75rem; }
        .chat-message.user { text-align: right; }
        .chat-message.assistant { text-align: left; }
        .chat-message .bubble { display: inline-block; padding: 0.6rem 0.9rem; border-radius: 12px; max-width: 85%; }
        .chat-message.user .bubble { background: #0F6CBD; color: #fff; }
        .chat-message.assistant .bubble { background: #fff; border: 1px solid #d1d1d6; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <span class="badge">Caf√©Caster ¬∑ FastAPI</span>
            <h2>Forecast for oms√¶tning & bemanding</h2>
            <p>Vol.2 logikken er migreret til v3 motoren. Du kan regulere horizon, timel√∏n og l√∏nandelen direkte her.</p>
        </header>

        <section class="panel controls">
            <h4>Scenario</h4>
            <form id="forecast-form">
                <div class="row">
                    <div class="six columns">
                        <label for="start-date">Startdato</label>
                        <input id="start-date" name="start_date" type="date" value="{{ default_start }}" required>
                    </div>
                    <div class="three columns">
                        <label for="horizon">Horisont (dage)</label>
                        <input id="horizon" name="horizon_days" type="number" min="1" max="14" value="{{ default_horizon }}" required>
                    </div>
                    <div class="three columns">
                        <label for="wage-pct">L√∏ndel (%)</label>
                        <input id="wage-pct" name="wage_pct" type="number" step="0.01" min="0" max="1" value="{{ initial.wage_pct }}">
                    </div>
                </div>
                <div class="row">
                    <div class="six columns">
                        <label for="hourly">Gns. timel√∏n (kr)</label>
                        <input id="hourly" name="avg_hourly_wage" type="number" min="1" value="{{ initial.avg_hourly_wage }}">
                    </div>
                    <div class="six columns u-pull-right" style="text-align:right;margin-top:1.9rem;">
                        <button type="submit" class="button-primary">Opdat√©r forecast</button>
                    </div>
                </div>
            </form>
            <div id="warning-stack"></div>
        </section>

        <section class="panel" id="manual-chat-panel">
            <div class="row">
                <div class="six columns">
                    <h4>Oms√¶tning & timer</h4>
                    <p id="model-meta">Model: {{ initial.model_backend }} ¬∑ version {{ initial.model_version }}</p>
                </div>
                <div class="six columns" style="text-align:right;">
                    <small>L√∏ndel {{ (initial.wage_pct * 100) | round(1) }}% ¬∑ Timel√∏n {{ initial.avg_hourly_wage | round(2) }} kr</small>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="forecast-table">
                    <thead>
                        <tr>
                            <th>Dato</th>
                            <th>Oms</th>
                            <th>An. timer</th>
                            <th>Planday</th>
                            <th>P-l√∏n %</th>
                            <th>Afvigelse</th>
                            <th>‚òÄÔ∏è Sol</th>
                            <th>üåßÔ∏è Nedb√∏r</th>
                            <th>üå°Ô∏è Temp</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section class="panel" id="log-panel">
            <div class="row">
                <div class="six columns">
                    <h4>Forecast log</h4>
                    <p>Seneste poster gemt i <code>{{ initial.get('log_path', './logs/forecast.log') }}</code></p>
                </div>
                <div class="six columns" style="text-align:right;">
                    <label for="log-limit">Poster</label>
                    <select id="log-limit" style="margin-right:0.5rem;">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                    </select>
                    <button id="refresh-log" class="button">Opdat√©r log</button>
                </div>
            </div>
            <ul id="log-entries" class="log-list"></ul>
        </section>

        <section class="panel">
            <div class="row">
                <div class="six columns">
                    <h4>Caf√©-r√•dgiver</h4>
                    <p>Stil sp√∏rgsm√•l om bemanding og drift ‚Äì svar leveres af OpenAI.</p>
                </div>
            </div>
            <div id="chatkit-host" data-config-url="/chat/config" data-openai-ready="{{ 'true' if openai_ready else 'false' }}">
                {% if not openai_ready %}
                    <p>Chat-widget placeholder. N√•r du tilf√∏jer din OpenAI-n√∏gle, vil <code>/chat/config</code> returnere <code>ready=true</code>.</p>
                {% endif %}
            </div>
        </section>

        <footer class="footer">
            Bygget med FastAPI + Skeleton CSS. Klar til Railway & ChatKit.
        </footer>
    </div>

    <script>
        const tableBody = document.querySelector("#forecast-table tbody");
        const warningStack = document.getElementById("warning-stack");
        const modelMeta = document.getElementById("model-meta");
        const initialData = {{ initial | tojson }};
        const defaultHourly = {{ initial.avg_hourly_wage | default(0) }};

        function formatNumber(value) {
            return new Intl.NumberFormat("da-DK", { maximumFractionDigits: 1 }).format(value);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat("da-DK", { maximumFractionDigits: 0 }).format(value);
        }

        function renderWarnings(warnings) {
            warningStack.innerHTML = "";
            (warnings || []).forEach(msg => {
                const div = document.createElement("div");
                div.className = "warning";
                div.textContent = msg;
                warningStack.appendChild(div);
            });
        }

        function renderTable(payload) {
            const { items = [] } = payload;
            tableBody.innerHTML = "";
            items.forEach(item => {
                const tr = document.createElement("tr");
                const diffClass = item.hours_diff > 1 ? "diff-positive" : item.hours_diff < -1 ? "diff-negative" : "";
                const wagePct = item.planday_hours != null && item.revenue_pred
                    ? (item.planday_hours * payload.avg_hourly_wage / item.revenue_pred) * 100
                    : null;
                tr.innerHTML = `
                    <td>${new Date(item.date).toLocaleDateString("da-DK", { weekday: "short", day: "numeric", month: "short" })}</td>
                    <td>${formatCurrency(item.revenue_pred)}</td>
                    <td>${formatNumber(item.hours_recommended)}</td>
                    <td>${item.planday_hours != null ? formatNumber(item.planday_hours) : "‚Äî"}</td>
                    <td>${wagePct != null ? formatNumber(wagePct) + " %" : "‚Äî"}</td>
                    <td class="${diffClass}">${item.hours_diff != null ? formatNumber(item.hours_diff) : "‚Äî"}</td>
                    <td>${item.sunshine_hours != null ? formatNumber(item.sunshine_hours) + " t" : "‚Äî"}</td>
                    <td>${item.precip_sum != null ? formatNumber(item.precip_sum) + " mm" : "‚Äî"}</td>
                    <td>${item.temp_max != null ? formatNumber(item.temp_max) + " ¬∞C" : "‚Äî"}</td>
                `;
                tableBody.appendChild(tr);
            });
            modelMeta.textContent = `Model: ${payload.model_backend} ¬∑ version ${payload.model_version}`;
            renderWarnings(payload.warnings);
        }

        function renderLogs(payload) {
            const list = document.getElementById("log-entries");
            list.innerHTML = "";
            const items = (payload && payload.items) || [];
            if (!items.length) {
                const li = document.createElement("li");
                li.textContent = "Ingen logposter endnu.";
                list.appendChild(li);
                return;
            }
            items.forEach(entry => {
                const details = document.createElement("details");
                details.className = "log-entry";
                const firstRow = entry.rows && entry.rows.length ? entry.rows[0] : null;
                const weather = entry.weather && entry.weather.length ? entry.weather[0] : null;
                const plandayActual = firstRow && firstRow.revenue_actual != null ? `${formatCurrency(firstRow.revenue_actual)} kr` : "‚Äî";
                const summaryText = `${entry.forecast_date} ¬∑ Planday oms: ${plandayActual} ¬∑ Oms√¶tning dag 1: ${firstRow ? formatCurrency(firstRow.revenue_pred) + " kr" : "‚Äî"} ¬∑ Timer: ${firstRow ? formatNumber(firstRow.hours_recommended) : "‚Äî"}`;
                const actualWeatherLine = firstRow && (
                    firstRow.temp_max_actual != null ||
                    firstRow.precip_sum_actual != null ||
                    firstRow.sunshine_hours_actual != null
                )
                    ? `<div class="log-weather">Vejr dag 1 (aktuel): ${firstRow.temp_max_actual != null ? formatNumber(firstRow.temp_max_actual) + " ¬∞C" : "‚Äî"}, ${firstRow.precip_sum_actual != null ? formatNumber(firstRow.precip_sum_actual) + " mm" : "‚Äî"}, ${firstRow.sunshine_hours_actual != null ? formatNumber(firstRow.sunshine_hours_actual) + " t" : "‚Äî"}</div>`
                    : "";
                details.innerHTML = `
                    <summary>${summaryText}</summary>
                    ${weather ? `<div class="log-weather">Vejr dag 1 (forecast): ${formatNumber(weather.temp_max)} ¬∞C, ${formatNumber(weather.precip_sum || 0)} mm, ${formatNumber(weather.sunshine_hours || 0)} t</div>` : ""}
                    ${actualWeatherLine}
                    ${renderLogTable(entry.rows || [])}
                `;
                list.appendChild(details);
            });
        }

        function renderLogTable(rows) {
            if (!rows.length) {
                return "";
            }
            const hourly = initialData?.avg_hourly_wage ?? defaultHourly;
                const tableRows = rows.map((row) => {
                    const wagePct = row.planday_hours != null && row.revenue_pred
                        ? (row.planday_hours * hourly / row.revenue_pred) * 100
                        : null;
                    const diffClass = row.hours_diff > 1 ? "diff-positive" : row.hours_diff < -1 ? "diff-negative" : "";
                    const actualText = row.revenue_actual != null ? formatCurrency(row.revenue_actual) : "‚Äî";
                    const sunActual = row.sunshine_hours_actual != null ? formatNumber(row.sunshine_hours_actual) + " t" : "‚Äî";
                    const precipActual = row.precip_sum_actual != null ? formatNumber(row.precip_sum_actual) + " mm" : "‚Äî";
                    const tempActual = row.temp_max_actual != null ? formatNumber(row.temp_max_actual) + " ¬∞C" : "‚Äî";
                    return `
                        <tr>
                            <td>${new Date(row.date).toLocaleDateString("da-DK", { weekday: "short", day: "numeric", month: "short" })}</td>
                            <td>${formatCurrency(row.revenue_pred)}</td>
                            <td>${actualText}</td>
                            <td>${formatNumber(row.hours_recommended)}</td>
                            <td>${row.planday_hours != null ? formatNumber(row.planday_hours) : "‚Äî"}</td>
                            <td>${wagePct != null ? formatNumber(wagePct) + " %" : "‚Äî"}</td>
                            <td class="${diffClass}">${row.hours_diff != null ? formatNumber(row.hours_diff) : "‚Äî"}</td>
                            <td>${row.sunshine_hours != null ? formatNumber(row.sunshine_hours) + " t" : "‚Äî"}</td>
                            <td>${row.precip_sum != null ? formatNumber(row.precip_sum) + " mm" : "‚Äî"}</td>
                            <td>${row.temp_max != null ? formatNumber(row.temp_max) + " ¬∞C" : "‚Äî"}</td>
                            <td>${sunActual}</td>
                            <td>${precipActual}</td>
                            <td>${tempActual}</td>
                        </tr>
                    `;
                }).join("");
                return `
                    <table class="log-table">
                    <thead>
                        <tr>
                            <th>Dato</th>
                            <th>Oms</th>
                            <th>Planday oms</th>
                            <th>An. timer</th>
                            <th>Planday timer</th>
                            <th>P-l√∏n %</th>
                            <th>Afvigelse</th>
                            <th>‚òÄÔ∏è Sol</th>
                            <th>üåßÔ∏è Nedb√∏r</th>
                            <th>üå°Ô∏è Temp</th>
                            <th>‚òÄÔ∏è Sol (akt)</th>
                            <th>üåßÔ∏è Nedb√∏r (akt)</th>
                            <th>üå°Ô∏è Temp (akt)</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;
        }

        async function loadLogs() {
            const limit = Number(document.getElementById("log-limit").value);
            try {
                const response = await fetch(`/logs?limit=${limit}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderLogs(data);
            } catch (error) {
                renderWarnings([`Kunne ikke hente log: ${error.message}`]);
            }
        }

        async function submitForm(event) {
            event.preventDefault();
            const form = event.target;
            const payload = {
                start_date: form.start_date.value,
                horizon_days: Number(form.horizon_days.value),
                wage_pct: form.wage_pct.value ? Number(form.wage_pct.value) : null,
                avg_hourly_wage: form.avg_hourly_wage.value ? Number(form.avg_hourly_wage.value) : null,
            };

            const button = form.querySelector("button[type=submit]");
            const originalLabel = button.textContent;
            button.textContent = "Henter...";
            button.disabled = true;

            try {
                const response = await fetch("/forecast", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `HTTP ${response.status}`);
                }
                const data = await response.json();
                renderTable(data);
                loadLogs();
            } catch (error) {
                renderWarnings([`Kunne ikke hente forecast: ${error.message}`]);
            } finally {
                button.textContent = originalLabel;
                button.disabled = false;
            }
        }

        document.getElementById("forecast-form").addEventListener("submit", submitForm);
        document.getElementById("refresh-log").addEventListener("click", () => loadLogs());
        document.getElementById("log-limit").addEventListener("change", () => loadLogs());

        renderTable(initialData);
        loadLogs();

        const chatKitHost = document.getElementById("chatkit-host");
        if (chatKitHost && chatKitHost.dataset.openaiReady === "true") {
            import("https://cdn.jsdelivr.net/npm/@openai/chat-components@0.2.2/+esm")
                .then((mod) => {
                    const { ChatKit } = mod || {};
                    if (!ChatKit) {
                        return;
                    }
                    chatKitHost.innerHTML = "";
                    ChatKit.mount({
                        element: chatKitHost,
                        config: {
                            title: "Caf√©-r√•dgiveren",
                            subtitle: "Sp√∏rg ind til bemanding, drift og vejr",
                            placeholder: "Sp√∏rg fx: Hvordan planl√¶gger vi weekenden?",
                        },
                        async fetchChatCompletions({ messages }) {
                            const normalized = (messages || []).map((message) => {
                                if (!message || !message.content) {
                                    return { role: message.role, content: "" };
                                }
                                const parts = Array.isArray(message.content)
                                    ? message.content
                                    : [{ type: "text", text: String(message.content) }];
                                const text = parts
                                    .map((part) => {
                                        if (!part) return "";
                                        if (typeof part === "string") return part;
                                        if (part.text) return part.text;
                                        if (part.input_text) return part.input_text;
                                        return "";
                                    })
                                    .filter(Boolean)
                                    .join("\n")
                                    .trim();
                                return {
                                    role: message.role,
                                    content: text,
                                };
                            });

                            const response = await fetch("/chat", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ messages: normalized }),
                            });
                            if (!response.ok) {
                                throw new Error(await response.text());
                            }
                            const data = await response.json();
                            return {
                                id: `chatcmpl-${Date.now()}`,
                                object: "chat.completion",
                                created: Math.floor(Date.now() / 1000),
                                model: "gpt-4o-mini",
                                choices: [
                                    {
                                        index: 0,
                                        message: {
                                            role: "assistant",
                                            content: [
                                                {
                                                    type: "text",
                                                    text: data.reply,
                                                },
                                            ],
                                        },
                                        finish_reason: "stop",
                                    },
                                ],
                            };
                        },
                    });
                })
                .catch((error) => {
                    console.warn("ChatKit kunne ikke indl√¶ses", error);
                    chatKitHost.innerHTML = "<p>ChatKit kunne ikke indl√¶ses. Pr√∏v at opdatere siden.</p>";
                });
        }
    </script>
</body>
</html>
