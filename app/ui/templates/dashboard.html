{% set initial = initial_forecast %}
<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Caf√©Caster v3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@openai/chat-components@0.2.2/dist/style.css">
    <style>
        body { background: #f7f7f7; color: #222; }
        header { margin: 3rem 0 2rem; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 999px; background: #0F6CBD; color: #fff; font-size: 0.8rem; }
        .panel { background: #fff; border-radius: 12px; padding: 2rem; box-shadow: 0 16px 40px rgba(15,107,189,0.08); margin-bottom: 2rem; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; border-bottom: 1px solid #e5e5ea; text-align: left; }
        th { background: linear-gradient(90deg, rgba(15,107,189,0.12), rgba(15,107,189,0.02)); font-weight: 600; }
        tr:hover { background: rgba(15,107,189,0.04); }
        .diff-positive { color: #0f766e; font-weight: 600; }
        .diff-negative { color: #b91c1c; font-weight: 600; }
        .warning { background: rgba(234,179,8,0.16); border-left: 4px solid #facc15; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 0.75rem; }
        .scenario-form .row { margin-bottom: 0.75rem; }
        .footer { margin: 4rem 0 2rem; text-align: center; color: #777; font-size: 0.9rem; }
        #agent-panel { margin-top: 1.2rem; }
        .agent-messages { background: radial-gradient(circle at top, rgba(15,107,189,0.06), rgba(15,107,189,0.01)); border: 1px solid rgba(15,107,189,0.15); border-radius: 18px; padding: 1.25rem; max-height: 360px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.85rem; box-shadow: inset 0 0 30px rgba(15,107,189,0.05); }
        .agent-message { display: flex; flex-direction: column; gap: 0.35rem; transition: transform 0.2s ease, opacity 0.2s ease; }
        .agent-message.agent-live { transform: translateY(-2px); opacity: 0.95; }
        .agent-bubble { display: inline-flex; align-items: flex-start; max-width: 82%; padding: 0.85rem 1.05rem; border-radius: 18px; box-shadow: 0 12px 34px rgba(15,107,189,0.14); backdrop-filter: blur(6px); white-space: pre-wrap; line-height: 1.45; font-size: 0.98rem; position: relative; }
        .agent-meta { font-size: 0.75rem; color: rgba(17, 24, 39, 0.5); text-transform: uppercase; letter-spacing: 0.08em; }
        .agent-message.agent-user { align-items: flex-end; }
        .agent-message.agent-user .agent-bubble { background: linear-gradient(135deg, #0F6CBD, #2563EB); color: #fff; border-bottom-right-radius: 6px; }
        .agent-message.agent-assistant { align-items: flex-start; }
        .agent-message.agent-assistant .agent-bubble { background: rgba(255,255,255,0.95); border: 1px solid rgba(15,107,189,0.12); border-bottom-left-radius: 6px; color: #0f172a; }
        .agent-message.agent-system .agent-bubble { background: rgba(185, 28, 28, 0.12); border: 1px solid rgba(185, 28, 28, 0.2); color: #7f1d1d; }
        .agent-form { display: flex; gap: 0.75rem; margin-top: 1rem; align-items: flex-end; }
        .agent-form textarea { flex: 1; resize: vertical; border-radius: 14px; border: 1px solid rgba(15,107,189,0.25); padding: 0.9rem 1rem; box-shadow: inset 0 2px 12px rgba(15,107,189,0.08); font-size: 0.95rem; }
        .agent-form textarea:focus { outline: none; border-color: #2563EB; box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
        .agent-form button { border-radius: 12px; padding: 0.75rem 1.4rem; box-shadow: 0 12px 32px rgba(37,99,235,0.22); }
        .agent-typing { font-size: 0.85rem; color: rgba(37,99,235,0.7); display: flex; align-items: center; gap: 0.4rem; }
        .agent-typing-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; opacity: 0.4; animation: typing 1.2s infinite ease-in-out; }
        .agent-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .agent-typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { opacity: 0.2; transform: translateY(0); } 40% { opacity: 1; transform: translateY(-3px); } }
        .similar-controls { display: inline-flex; align-items: center; gap: 0.75rem; justify-content: flex-end; width: 100%; }
        .similar-grid { display: grid; gap: 1.25rem; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-top: 1.5rem; }
        .similar-column { display: flex; flex-direction: column; gap: 0.65rem; }
        .similar-label { font-size: 0.9rem; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(37,99,235,0.85); }
        .similar-card { background: linear-gradient(180deg, rgba(15,107,189,0.08), rgba(15,107,189,0.02)); border: 1px solid rgba(37, 99, 235, 0.15); border-radius: 16px; padding: 1.2rem 1.35rem; box-shadow: 0 18px 35px rgba(15,107,189,0.12); display: flex; flex-direction: column; gap: 0.75rem; }
        .similar-card .similar-date { font-size: 0.95rem; font-weight: 600; color: rgba(15,23,42,0.8); text-transform: uppercase; letter-spacing: 0.08em; }
        .similar-card .similar-oms { font-size: 1.6rem; font-weight: 700; color: #2563eb; }
        .similar-card .similar-meta { font-size: 0.85rem; color: rgba(15,107,189,0.65); letter-spacing: 0.05em; text-transform: uppercase; }
        .similar-card .similar-weather { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 0.6rem; font-size: 0.82rem; }
        .similar-card .similar-weather span { display: block; background: rgba(255,255,255,0.6); border-radius: 10px; padding: 0.55rem 0.6rem; box-shadow: inset 0 0 12px rgba(37,99,235,0.08); }
        .similar-card .similar-weather span strong { display: block; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(17, 24, 39, 0.55); }
        .similar-card .similar-weather span em { display: block; font-style: normal; font-weight: 600; color: #0f172a; margin-top: 0.2rem; }
        .similar-card .similar-diff { font-size: 0.8rem; color: rgba(15,23,42,0.7); }
        #calendar-panel .calendar-meta { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between; margin-top: 1rem; }
        #calendar-panel .calendar-error { color: #b91c1c; margin-top: 0.5rem; font-weight: 600; }
        #calendar-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #calendar-table thead th { text-align: center; background: linear-gradient(90deg, rgba(37, 99, 235, 0.15), rgba(37, 99, 235, 0.02)); padding: 0.75rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.85rem; }
        #calendar-table tbody td { border-bottom: 1px solid #e5e5ea; padding: 0.85rem 0.5rem; text-align: center; min-width: 110px; }
        .calendar-week-label { font-weight: 600; text-align: left !important; white-space: nowrap; }
        .calendar-sum { font-weight: 600; color: #0f172a; }
        .calendar-day { display: flex; flex-direction: column; gap: 0.25rem; align-items: center; justify-content: center; }
        .calendar-day-date { font-size: 0.75rem; color: rgba(15,107,189,0.7); letter-spacing: 0.08em; text-transform: uppercase; }
        .calendar-day-value { font-size: 0.95rem; font-weight: 600; color: #0f172a; }
        .calendar-day-wage { font-size: 0.75rem; color: rgba(15,107,189,0.8); }
        .calendar-day-empty { color: #cbd5f5; }
        .similar-summary { margin-top: 0.75rem; font-size: 0.95rem; color: #334155; }
        .log-list { list-style: none; padding-left: 0; margin-top: 1rem; }
        .log-list li { border-bottom: 1px solid #e5e5ea; padding: 0.75rem 0; }
        .log-meta { font-size: 0.85rem; color: #555; display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .log-weather { margin-top: 0.5rem; font-size: 0.85rem; color: #333; }
        details.log-entry { margin-bottom: 0.75rem; border: 1px solid #e5e5ea; border-radius: 8px; padding: 0.75rem 1rem; background: #fafafa; }
        details.log-entry summary { cursor: pointer; font-weight: 600; outline: none; }
        .log-table { width: 100%; border-collapse: collapse; margin-top: 0.75rem; }
        .log-table th, .log-table td { font-size: 0.85rem; text-align: left; padding: 0.35rem 0.5rem; border-bottom: 1px solid #e5e5ea; }
        .log-table th { font-weight: 600; color: #444; background: rgba(15,107,189,0.08); }
        .log-table tr:last-child td { border-bottom: none; }
        .chat-window { border: 1px solid #e5e5ea; border-radius: 8px; padding: 1rem; max-height: 320px; overflow-y: auto; background: #fafafa; }
        .chat-message { margin-bottom: 0.75rem; }
        .chat-message.user { text-align: right; }
        .chat-message.assistant { text-align: left; }
        .chat-message .bubble { display: inline-block; padding: 0.6rem 0.9rem; border-radius: 12px; max-width: 85%; }
        .chat-message.user .bubble { background: #0F6CBD; color: #fff; }
        .chat-message.assistant .bubble { background: #fff; border: 1px solid #d1d1d6; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <span class="badge">Caf√©Caster ¬∑ FastAPI</span>
            <h2>Caf√© Flindt og √òrsted - Forecast for oms√¶tning & bemanding</h2>
        </header>

        <section class="panel" id="manual-chat-panel">
            <div class="row">
                <div class="six columns">
                    <h4>Oms√¶tning & timer</h4>
                </div>
                <div class="six columns" style="text-align:right;">
                    <small>L√∏ndel {{ (initial.wage_pct * 100) | round(1) }}% ¬∑ Timel√∏n {{ initial.avg_hourly_wage | round(2) }} kr</small>
                </div>
            </div>
            <form id="forecast-form" class="scenario-form">
                <div class="row">
                    <div class="six columns">
                        <label for="start-date">Startdato</label>
                        <input id="start-date" name="start_date" type="date" value="{{ default_start }}" required>
                    </div>
                    <div class="three columns">
                        <label for="horizon">Horisont (dage)</label>
                        <input id="horizon" name="horizon_days" type="number" min="1" max="14" value="{{ default_horizon }}" required>
                    </div>
                    <div class="three columns">
                        <label for="wage-pct">L√∏ndel (%)</label>
                        <input id="wage-pct" name="wage_pct" type="number" step="0.01" min="0" max="1" value="{{ initial.wage_pct }}">
                    </div>
                </div>
                <div class="row">
                    <div class="six columns">
                        <label for="hourly">Gns. timel√∏n (kr)</label>
                        <input id="hourly" name="avg_hourly_wage" type="number" min="1" value="{{ initial.avg_hourly_wage }}">
                    </div>
                    <div class="six columns u-pull-right" style="text-align:right;margin-top:1.9rem;">
                        <button type="submit" class="button-primary">Opdat√©r forecast</button>
                    </div>
                </div>
            </form>
            <div id="warning-stack"></div>
            <div class="table-wrapper">
                <table id="forecast-table">
                    <thead>
                        <tr>
                            <th>Dato</th>
                            <th>Oms</th>
                            <th>An. timer</th>
                            <th>Planday</th>
                            <th>P-l√∏n %</th>
                            <th>Afvigelse</th>
                            <th>‚òÄÔ∏è Sol</th>
                            <th>üåßÔ∏è Nedb√∏r</th>
                            <th>üå°Ô∏è Temp</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section class="panel" id="calendar-panel">
            <div class="row">
                <div class="six columns">
                    <h4>Kalender-forecast (Y)</h4>
                    <p>Viser dagsoms√¶tning og l√∏nbudget fordelt p√• ISO-uger. Kolonner er mandag til s√∏ndag, r√¶kker er uge for uge.</p>
                </div>
                <div class="six columns">
                    <form id="calendar-form" class="calendar-form">
                        <div class="row">
                            <div class="four columns">
                                <label for="calendar-start">Startdato</label>
                                <input type="date" id="calendar-start" name="start_date" value="{{ default_start }}">
                            </div>
                            <div class="four columns">
                                <label for="calendar-horizon">Horisont (7-120)</label>
                                <input type="number" id="calendar-horizon" name="horizon_days" value="30" min="7" max="120">
                            </div>
                            <div class="four columns">
                                <label for="calendar-wage">L√∏n%</label>
                                <input type="number" id="calendar-wage" name="wage_pct" value="0.25" min="0.10" max="0.50" step="0.01">
                            </div>
                        </div>
                        <div class="row" style="margin-top:0.5rem;">
                            <div class="twelve columns" style="text-align:right;">
                                <button type="submit" class="button-primary">Opdat√©r kalender</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="calendar-meta">
                <div id="calendar-summary"></div>
                <div id="calendar-meta-totals"></div>
            </div>
            <div id="calendar-error" class="calendar-error"></div>
            <div class="table-wrapper">
                <table id="calendar-table">
                    <thead>
                        <tr>
                            <th>Uge</th>
                            <th>Y (sum)</th>
                            <th>Mandag</th>
                            <th>Tirsdag</th>
                            <th>Onsdag</th>
                            <th>Torsdag</th>
                            <th>Fredag</th>
                            <th>L√∏rdag</th>
                            <th>S√∏ndag</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section class="panel" id="log-panel">
            <div class="row">
                <div class="six columns">
                    <h4>Forecast log</h4>
                    <p>Seneste poster gemt i <code>{{ initial.get('log_path', './logs/forecast.log') }}</code></p>
                </div>
                <div class="six columns" style="text-align:right;">
                    <label for="log-limit">Poster</label>
                    <select id="log-limit" style="margin-right:0.5rem;">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                    </select>
                    <button id="refresh-log" class="button">Opdat√©r log</button>
                </div>
            </div>
            <ul id="log-entries" class="log-list"></ul>
        </section>

        <section class="panel" id="similar-panel">
            <div class="row">
                <div class="six columns">
                    <h4>Hvilke dage ligner denne?</h4>
                    <p>Find historiske dage med lignende vejr- og oms√¶tningsm√∏nstre.</p>
                </div>
                <div class="six columns" style="text-align:right;">
                    <label for="similar-date" style="display:block;">Dato</label>
                    <div class="similar-controls">
                        <input id="similar-date" type="date" value="{{ default_start }}">
                        <button id="similar-refresh" class="button">Analyser</button>
                    </div>
                </div>
            </div>
            <div id="similar-summary" class="similar-summary">V√¶lg en dato for at se lignende dage.</div>
            <div class="similar-heading" style="display:flex; gap:1rem; margin-top:1rem; font-size:0.9rem; letter-spacing:0.08em; text-transform:uppercase; color: rgba(37, 99, 235, 0.75);">
                <span>Regn</span>
                <span>Solskin</span>
                <span>Regn + sol</span>
                <span>Temperatur</span>
                <span>Samlet</span>
            </div>
            <div id="similar-results" class="similar-grid"></div>
        </section>

        <section class="panel">
            <div class="row">
                <div class="six columns">
                    <h4>Caf√©-r√•dgiver</h4>
                    <p>Stil sp√∏rgsm√•l om bemanding og drift ‚Äì svar leveres af OpenAI-agenten.</p>
                </div>
            </div>
            <div id="agent-panel" data-ready="{{ 'true' if openai_ready else 'false' }}">
                {% if openai_ready %}
                    <div id="agent-messages" class="agent-messages"></div>
                    <form id="agent-form" class="agent-form">
                        <textarea id="agent-input" rows="3" placeholder="Skriv din besked‚Ä¶" required></textarea>
                        <button type="submit" class="button-primary" id="agent-send">Send</button>
                    </form>
                {% else %}
                    <p>Tilf√∏j din <code>OPENAI_API_KEY</code> for at aktivere chatten.</p>
                {% endif %}
            </div>
        </section>

        <footer class="footer">
            Bygget med FastAPI + Skeleton CSS. Klar til Railway & ChatKit.
        </footer>
    </div>

    <script>
        const tableBody = document.querySelector("#forecast-table tbody");
        const warningStack = document.getElementById("warning-stack");
        const initialData = {{ initial | tojson }};
        const defaultHourly = {{ initial.avg_hourly_wage | default(0) }};
        const calendarForm = document.getElementById("calendar-form");
        const calendarTableBody = document.querySelector("#calendar-table tbody");
        const calendarErrorEl = document.getElementById("calendar-error");
        const calendarSummaryEl = document.getElementById("calendar-summary");
        const calendarTotalsEl = document.getElementById("calendar-meta-totals");

        function formatNumber(value) {
            return new Intl.NumberFormat("da-DK", { maximumFractionDigits: 1 }).format(value);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat("da-DK", { maximumFractionDigits: 0 }).format(value);
        }

        function formatTwoDecimals(value) {
            return new Intl.NumberFormat("da-DK", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }

        function buildForecastPayload(form) {
            return {
                start_date: form.start_date.value,
                horizon_days: Number(form.horizon_days.value),
                wage_pct: form.wage_pct.value ? Number(form.wage_pct.value) : null,
                avg_hourly_wage: form.avg_hourly_wage.value ? Number(form.avg_hourly_wage.value) : null,
            };
        }

        function renderWarnings(warnings) {
            warningStack.innerHTML = "";
            (warnings || []).forEach(msg => {
                const div = document.createElement("div");
                div.className = "warning";
                div.textContent = msg;
                warningStack.appendChild(div);
            });
        }

        const calendarWeekdays = [
            { iso: 1, label: "Man" },
            { iso: 2, label: "Tir" },
            { iso: 3, label: "Ons" },
            { iso: 4, label: "Tor" },
            { iso: 5, label: "Fre" },
            { iso: 6, label: "L√∏r" },
            { iso: 7, label: "S√∏n" },
        ];

        function renderCalendar(payload) {
            if (!calendarTableBody) return;
            const data = payload || {};
            const daily = Array.isArray(data.daily) ? data.daily : [];
            const weekly = Array.isArray(data.weekly) ? data.weekly : [];
            const meta = data.meta || null;

            const dailyByWeek = new Map();
            daily.forEach((item) => {
                const key = `${item.iso_year}-${String(item.iso_week).padStart(2, "0")}`;
                if (!dailyByWeek.has(key)) {
                    dailyByWeek.set(key, new Map());
                }
                dailyByWeek.get(key).set(item.iso_weekday, item);
            });

            calendarTableBody.innerHTML = "";

            if (!weekly.length) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="9">Ingen data i intervallet.</td>`;
                calendarTableBody.appendChild(tr);
            } else {
                weekly.forEach((week) => {
                    const key = `${week.iso_year}-${String(week.iso_week).padStart(2, "0")}`;
                    const dayMap = dailyByWeek.get(key) || new Map();
                    const cells = calendarWeekdays.map(({ iso, label }) => {
                        const day = dayMap.get(iso);
                        if (!day) {
                            return `<td><div class="calendar-day calendar-day-empty">‚Äî</div></td>`;
                        }
                        const dayDate = new Date(day.date);
                        const dateText = dayDate.toLocaleDateString("da-DK", { day: "2-digit", month: "short" });
                        const forecastText = day.forecast != null ? formatTwoDecimals(day.forecast) : "‚Äî";
                        const wageText = day.wage != null ? formatTwoDecimals(day.wage) : null;
                        const wageLine = wageText ? `<span class="calendar-day-wage">${wageText} l√∏n</span>` : "";
                        const classes = ["calendar-day"];
                        if (day.forecast == null) {
                            classes.push("calendar-day-empty");
                        }
                        return `<td>
                            <div class="${classes.join(" ")}">
                                <span class="calendar-day-date">${label} ${dateText}</span>
                                <span class="calendar-day-value">${forecastText}</span>
                                ${wageLine}
                            </div>
                        </td>`;
                    }).join("");
                    const tr = document.createElement("tr");
                    const sumText = week.sum_forecast != null ? formatTwoDecimals(week.sum_forecast) : "‚Äî";
                    tr.innerHTML = `
                        <td class="calendar-week-label">Uge ${week.iso_week} ¬∑ ${week.iso_year}</td>
                        <td class="calendar-sum">${sumText}</td>
                        ${cells}
                    `;
                    calendarTableBody.appendChild(tr);
                });
            }

            if (calendarErrorEl) {
                calendarErrorEl.textContent = "";
            }
            if (calendarSummaryEl && meta) {
                const intervalText = `${meta.start_date} ‚Üí ${meta.end_date}`;
                calendarSummaryEl.textContent = `Interval: ${intervalText} ¬∑ Dage: ${meta.n_days_forecasted}/${meta.n_days}`;
            }
            if (calendarTotalsEl && meta) {
                const totalForecast = meta.total_forecast != null ? formatTwoDecimals(meta.total_forecast) : "‚Äî";
                const totalWage = meta.total_wage != null ? formatTwoDecimals(meta.total_wage) : "‚Äî";
                const wagePct = meta.wage_pct != null ? (meta.wage_pct * 100).toFixed(0) : "‚Äî";
                calendarTotalsEl.textContent = `Total Y: ${totalForecast} ¬∑ L√∏n: ${totalWage} ¬∑ L√∏n%: ${wagePct}%`;
            }
        }

        function showCalendarError(message) {
            if (calendarErrorEl) {
                calendarErrorEl.textContent = message;
            }
            if (calendarSummaryEl) {
                calendarSummaryEl.textContent = "";
            }
            if (calendarTotalsEl) {
                calendarTotalsEl.textContent = "";
            }
            if (calendarTableBody) {
                calendarTableBody.innerHTML = `<tr><td colspan="9">Ingen data</td></tr>`;
            }
        }

        async function loadCalendarForecast() {
            if (!calendarForm) return;
            const payload = {
                start_date: calendarForm.start_date.value,
                horizon_days: Number(calendarForm.horizon_days.value),
                wage_pct: Number(calendarForm.wage_pct.value),
            };

            if (!payload.start_date) {
                payload.start_date = new Date().toISOString().slice(0, 10);
                calendarForm.start_date.value = payload.start_date;
            }

            if (Number.isNaN(payload.horizon_days)) {
                showCalendarError("Angiv en horisont mellem 7 og 120 dage.");
                return;
            }
            if (payload.horizon_days < 7 || payload.horizon_days > 120) {
                showCalendarError("Horisont skal v√¶re mellem 7 og 120 dage.");
                return;
            }
            if (Number.isNaN(payload.wage_pct)) {
                showCalendarError("Angiv en gyldig l√∏nprocent (0.10-0.50).");
                return;
            }
            if (payload.wage_pct < 0.10 || payload.wage_pct > 0.50) {
                showCalendarError("L√∏nprocent skal v√¶re mellem 0.10 og 0.50.");
                return;
            }

            if (calendarTableBody) {
                calendarTableBody.innerHTML = `<tr><td colspan="9">Henter kalender‚Ä¶</td></tr>`;
            }
            if (calendarSummaryEl) {
                calendarSummaryEl.textContent = "Henter kalender‚Ä¶";
            }
            if (calendarTotalsEl) {
                calendarTotalsEl.textContent = "";
            }
            if (calendarErrorEl) {
                calendarErrorEl.textContent = "";
            }

            try {
                const response = await fetch("/calendar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const text = await response.text();
                    let message = text || `HTTP ${response.status}`;
                    try {
                        const parsed = JSON.parse(text);
                        if (Array.isArray(parsed.detail)) {
                            message = parsed.detail
                                .map((item) => item.msg || item.detail || item)
                                .join(", ");
                        } else if (parsed.detail) {
                            message = typeof parsed.detail === "string"
                                ? parsed.detail
                                : JSON.stringify(parsed.detail);
                        }
                    } catch (parseError) {
                        // ignore
                    }
                    throw new Error(message);
                }
                const data = await response.json();
                renderCalendar(data);
            } catch (error) {
                showCalendarError(`Kunne ikke hente kalender: ${error.message}`);
            }
        }

        function renderTable(payload) {
            const { items = [] } = payload;
            tableBody.innerHTML = "";
            items.forEach(item => {
                const tr = document.createElement("tr");
                const diffClass = item.hours_diff > 1 ? "diff-positive" : item.hours_diff < -1 ? "diff-negative" : "";
                const wagePct = item.planday_hours != null && item.revenue_pred
                    ? (item.planday_hours * payload.avg_hourly_wage / item.revenue_pred) * 100
                    : null;
                tr.innerHTML = `
                    <td>${new Date(item.date).toLocaleDateString("da-DK", { weekday: "short", day: "numeric", month: "short" })}</td>
                    <td>${formatCurrency(item.revenue_pred)}</td>
                    <td>${formatNumber(item.hours_recommended)}</td>
                    <td>${item.planday_hours != null ? formatNumber(item.planday_hours) : "‚Äî"}</td>
                    <td>${wagePct != null ? formatNumber(wagePct) + " %" : "‚Äî"}</td>
                    <td class="${diffClass}">${item.hours_diff != null ? formatNumber(item.hours_diff) : "‚Äî"}</td>
                    <td>${item.sunshine_hours != null ? formatNumber(item.sunshine_hours) + " t" : "‚Äî"}</td>
                    <td>${item.precip_sum != null ? formatNumber(item.precip_sum) + " mm" : "‚Äî"}</td>
                    <td>${item.temp_max != null ? formatNumber(item.temp_max) + " ¬∞C" : "‚Äî"}</td>
                `;
                tableBody.appendChild(tr);
            });
            renderWarnings(payload.warnings);
        }

        function renderLogs(payload) {
            const list = document.getElementById("log-entries");
            list.innerHTML = "";
            const items = (payload && payload.items) || [];
            if (!items.length) {
                const li = document.createElement("li");
                li.textContent = "Ingen logposter endnu.";
                list.appendChild(li);
                return;
            }
            items.forEach(entry => {
                const details = document.createElement("details");
                details.className = "log-entry";
                const firstRow = entry.rows && entry.rows.length ? entry.rows[0] : null;
                const weather = entry.weather && entry.weather.length ? entry.weather[0] : null;
                const plandayActual = firstRow && firstRow.revenue_actual != null ? `${formatCurrency(firstRow.revenue_actual)} kr` : "‚Äî";
                const summaryText = `${entry.forecast_date} ¬∑ Planday oms: ${plandayActual} ¬∑ Oms√¶tning dag 1: ${firstRow ? formatCurrency(firstRow.revenue_pred) + " kr" : "‚Äî"} ¬∑ Timer: ${firstRow ? formatNumber(firstRow.hours_recommended) : "‚Äî"}`;
                const actualWeatherLine = firstRow && (
                    firstRow.temp_max_actual != null ||
                    firstRow.precip_sum_actual != null ||
                    firstRow.sunshine_hours_actual != null
                )
                    ? `<div class="log-weather">Vejr dag 1 (aktuel): ${firstRow.temp_max_actual != null ? formatNumber(firstRow.temp_max_actual) + " ¬∞C" : "‚Äî"}, ${firstRow.precip_sum_actual != null ? formatNumber(firstRow.precip_sum_actual) + " mm" : "‚Äî"}, ${firstRow.sunshine_hours_actual != null ? formatNumber(firstRow.sunshine_hours_actual) + " t" : "‚Äî"}</div>`
                    : "";
                details.innerHTML = `
                    <summary>${summaryText}</summary>
                    ${weather ? `<div class="log-weather">Vejr dag 1 (forecast): ${formatNumber(weather.temp_max)} ¬∞C, ${formatNumber(weather.precip_sum || 0)} mm, ${formatNumber(weather.sunshine_hours || 0)} t</div>` : ""}
                    ${actualWeatherLine}
                    ${renderLogTable(entry.rows || [])}
                `;
                list.appendChild(details);
            });
        }

        function renderLogTable(rows) {
            if (!rows.length) {
                return "";
            }
            const hourly = initialData?.avg_hourly_wage ?? defaultHourly;
                const tableRows = rows.map((row) => {
                    const wagePct = row.planday_hours != null && row.revenue_pred
                        ? (row.planday_hours * hourly / row.revenue_pred) * 100
                        : null;
                    const diffClass = row.hours_diff > 1 ? "diff-positive" : row.hours_diff < -1 ? "diff-negative" : "";
                    const actualText = row.revenue_actual != null ? formatCurrency(row.revenue_actual) : "‚Äî";
                    const sunActual = row.sunshine_hours_actual != null ? formatNumber(row.sunshine_hours_actual) + " t" : "‚Äî";
                    const precipActual = row.precip_sum_actual != null ? formatNumber(row.precip_sum_actual) + " mm" : "‚Äî";
                    const tempActual = row.temp_max_actual != null ? formatNumber(row.temp_max_actual) + " ¬∞C" : "‚Äî";
                    return `
                        <tr>
                            <td>${new Date(row.date).toLocaleDateString("da-DK", { weekday: "short", day: "numeric", month: "short" })}</td>
                            <td>${formatCurrency(row.revenue_pred)}</td>
                            <td>${actualText}</td>
                            <td>${formatNumber(row.hours_recommended)}</td>
                            <td>${row.planday_hours != null ? formatNumber(row.planday_hours) : "‚Äî"}</td>
                            <td>${wagePct != null ? formatNumber(wagePct) + " %" : "‚Äî"}</td>
                            <td class="${diffClass}">${row.hours_diff != null ? formatNumber(row.hours_diff) : "‚Äî"}</td>
                            <td>${row.sunshine_hours != null ? formatNumber(row.sunshine_hours) + " t" : "‚Äî"}</td>
                            <td>${row.precip_sum != null ? formatNumber(row.precip_sum) + " mm" : "‚Äî"}</td>
                            <td>${row.temp_max != null ? formatNumber(row.temp_max) + " ¬∞C" : "‚Äî"}</td>
                            <td>${sunActual}</td>
                            <td>${precipActual}</td>
                            <td>${tempActual}</td>
                        </tr>
                    `;
                }).join("");
                return `
                    <table class="log-table">
                    <thead>
                        <tr>
                            <th>Dato</th>
                            <th>Oms</th>
                            <th>Planday oms</th>
                            <th>An. timer</th>
                            <th>Planday timer</th>
                            <th>P-l√∏n %</th>
                            <th>Afvigelse</th>
                            <th>‚òÄÔ∏è Sol</th>
                            <th>üåßÔ∏è Nedb√∏r</th>
                            <th>üå°Ô∏è Temp</th>
                            <th>‚òÄÔ∏è Sol (akt)</th>
                            <th>üåßÔ∏è Nedb√∏r (akt)</th>
                            <th>üå°Ô∏è Temp (akt)</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;
        }

        async function loadLogs() {
            const limit = Number(document.getElementById("log-limit").value);
            try {
                const response = await fetch(`/logs?limit=${limit}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderLogs(data);
            } catch (error) {
                renderWarnings([`Kunne ikke hente log: ${error.message}`]);
            }
        }

        async function submitForm(event) {
            event.preventDefault();
            const form = event.target;
            const payload = buildForecastPayload(form);

            const button = form.querySelector("button[type=submit]");
            const originalLabel = button.textContent;
            button.textContent = "Henter...";
            button.disabled = true;

            try {
                const response = await fetch("/forecast", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || `HTTP ${response.status}`);
                }
                const data = await response.json();
                renderTable(data);
                loadLogs();
            } catch (error) {
                renderWarnings([`Kunne ikke hente forecast: ${error.message}`]);
            } finally {
                button.textContent = originalLabel;
                button.disabled = false;
            }
        }
        const forecastForm = document.getElementById("forecast-form");
        if (forecastForm) {
            forecastForm.addEventListener("submit", submitForm);
        }
        if (calendarForm) {
            calendarForm.addEventListener("submit", (event) => {
                event.preventDefault();
                loadCalendarForecast();
            });
            loadCalendarForecast();
        }
        document.getElementById("refresh-log").addEventListener("click", () => loadLogs());
        document.getElementById("log-limit").addEventListener("change", () => loadLogs());

        renderTable(initialData);
        loadLogs();
        if (forecastForm) {
        }

        const similarResultsEl = document.getElementById("similar-results");
        const similarSummaryEl = document.getElementById("similar-summary");
        const similarDateInput = document.getElementById("similar-date");
        const similarRefreshBtn = document.getElementById("similar-refresh");

        function formatHours(seconds) {
            if (seconds == null) return "‚Äî";
            const hours = Number(seconds) / 3600;
            return `${formatNumber(hours)} t`;
        }

        function renderSimilar(data) {
            if (!similarResultsEl || !similarSummaryEl) {
                return;
            }
            const matches = data.matches || [];
            if (!matches.length) {
                similarSummaryEl.textContent = "Ingen historiske dage matcher kriterierne.";
                similarResultsEl.innerHTML = "";
                return;
            }
            const target = data.target || {};
            const targetDate = target.date ? new Date(target.date) : null;
            const targetLabel = targetDate
                ? targetDate.toLocaleDateString("da-DK", { weekday: "long", day: "numeric", month: "long", year: "numeric" })
                : "Ukendt dato";
            const targetOmsText = target.oms != null ? `${formatCurrency(target.oms)} kr` : "‚Äî";
            similarSummaryEl.textContent = `Udgangspunkt: ${targetLabel} ¬∑ Oms ${targetOmsText} ¬∑ Regn ${formatNumber(target.rain || 0)} mm ¬∑ Sol ${formatHours(target.sunshine_duration || 0)} ¬∑ Temp ${formatNumber(target.temperature_2m || 0)} ¬∞C`;

            similarResultsEl.innerHTML = matches.map(match => {
                const matchDate = match.date ? new Date(match.date) : null;
                const dateLabel = matchDate
                    ? matchDate.toLocaleDateString("da-DK", { weekday: "short", day: "numeric", month: "short", year: "numeric" })
                    : match.date;
                const omsText = match.oms != null ? `${formatCurrency(match.oms)} kr` : "‚Äî";
                const diffText = match.difference != null ? formatNumber(match.difference) : "‚Äî";
                return `
                    <div class="similar-column">
                        <div class="similar-label">${match.label}</div>
                        <article class="similar-card">
                            <div class="similar-date">${dateLabel}</div>
                            <div class="similar-oms">${omsText}</div>
                            <div class="similar-meta">Uge ${match.week || "‚Äî"} ¬∑ ${match.weekday || ""}</div>
                            <div class="similar-weather">
                                <span><strong>Regn</strong><em>${formatNumber(match.rain || 0)} mm</em></span>
                                <span><strong>Sol</strong><em>${formatHours(match.sunshine_duration || 0)}</em></span>
                                <span><strong>Regn + sol</strong><em>${formatNumber(match.rain || 0)} mm / ${formatHours(match.sunshine_duration || 0)}</em></span>
                                <span><strong>Temp</strong><em>${formatNumber(match.temperature_2m || 0)} ¬∞C</em></span>
                            </div>
                            <div class="similar-diff">Afstand: ${diffText}</div>
                        </article>
                    </div>
                `;
            }).join("");
        }

        async function loadSimilarDays(dateValue) {
            if (!similarSummaryEl || !similarResultsEl) return;
            if (!dateValue) {
                similarSummaryEl.textContent = "V√¶lg en gyldig dato.";
                return;
            }
            similarSummaryEl.textContent = "Finder lignende dage‚Ä¶";
            similarResultsEl.innerHTML = "";
            try {
                const response = await fetch(`/history/similar?date=${encodeURIComponent(dateValue)}`);
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                const payload = await response.json();
                renderSimilar(payload);
            } catch (error) {
                similarSummaryEl.textContent = `Kunne ikke hente lignende dage: ${error.message}`;
            }
        }

        if (similarRefreshBtn && similarDateInput) {
            similarRefreshBtn.addEventListener("click", () => {
                loadSimilarDays(similarDateInput.value);
            });
            similarDateInput.addEventListener("change", () => loadSimilarDays(similarDateInput.value));
            if (similarDateInput.value) {
                loadSimilarDays(similarDateInput.value);
            }
        }

        const agentPanel = document.getElementById("agent-panel");
        if (agentPanel && agentPanel.dataset.ready === "true") {
            const threadId = crypto.randomUUID();
            const messagesEl = document.getElementById("agent-messages");
                    const formEl = document.getElementById("agent-form");
                    const inputEl = document.getElementById("agent-input");
                    const sendBtn = document.getElementById("agent-send");
                    let typingEl = null;

                    function appendMessage(role, content) {
                        const row = document.createElement("div");
                        row.className = `agent-message agent-${role}`;
                        const meta = document.createElement("div");
                        meta.className = "agent-meta";
                        meta.textContent = role === "user" ? "Du" : role === "assistant" ? "Caf√©-r√•dgiver" : "System";
                        const bubble = document.createElement("div");
                        bubble.className = "agent-bubble";
                        bubble.textContent = content;
                        row.appendChild(meta);
                        row.appendChild(bubble);
                        messagesEl.appendChild(row);
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    }

                    function showTyping() {
                        if (typingEl) return;
                        const wrapper = document.createElement("div");
                        wrapper.className = "agent-message agent-assistant";
                        typingEl = wrapper;
                        const meta = document.createElement("div");
                        meta.className = "agent-meta";
                        meta.textContent = "Caf√©-r√•dgiver";
                        const bubble = document.createElement("div");
                        bubble.className = "agent-bubble agent-typing";
                        bubble.innerHTML = '<span class="agent-typing-dot"></span><span class="agent-typing-dot"></span><span class="agent-typing-dot"></span>';
                        wrapper.appendChild(meta);
                        wrapper.appendChild(bubble);
                        messagesEl.appendChild(wrapper);
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    }

                    function hideTyping() {
                        if (!typingEl) return;
                        typingEl.remove();
                        typingEl = null;
                    }

                    async function streamAgentMessage(message) {
                        appendMessage("user", message);
                        sendBtn.disabled = true;
                        let buffer = "";
                        let assistantChunk = "";
                try {
                    const response = await fetch("/agent/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message, thread_id: threadId }),
                    });
                    if (!response.ok || !response.body) {
                        throw new Error(`Agentfejl: ${response.status}`);
                    }
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        let endIdx;
                        while ((endIdx = buffer.indexOf("\n\n")) >= 0) {
                            const raw = buffer.slice(0, endIdx).trim();
                            buffer = buffer.slice(endIdx + 2);
                            if (!raw.startsWith("data:")) continue;
                            const payloadTxt = raw.slice(5).trim();
                            if (!payloadTxt) continue;
                            let payload;
                            try {
                                payload = JSON.parse(payloadTxt);
                            } catch {
                                continue;
                            }
                            if (payload.event === "done") {
                                if (assistantChunk) {
                                    appendMessage("assistant", assistantChunk.trim());
                                }
                                assistantChunk = "";
                                continue;
                            }
                            if (payload.content) {
                                assistantChunk += `${payload.content} `;
                                hideTyping();
                                appendMessage("assistant", assistantChunk.trim());
                                messagesEl.lastChild.classList.add("agent-live");
                                assistantChunk = "";
                            }
                        }
                    }
                    hideTyping();
                    if (assistantChunk.trim()) {
                        appendMessage("assistant", assistantChunk.trim());
                    }
                } catch (error) {
                    hideTyping();
                    appendMessage("system", `Kunne ikke kontakte agenten: ${error.message}`);
                } finally {
                    sendBtn.disabled = false;
                }
            }

            formEl?.addEventListener("submit", (event) => {
                event.preventDefault();
                const message = inputEl.value.trim();
                if (!message) return;
                inputEl.value = "";
                showTyping();
                streamAgentMessage(message);
            });
        }
    </script>

</body>
</html>
